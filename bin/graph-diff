#!/usr/bin/env perl

=head1
graph-diff
=head2
This script is used to diff two graphs generated by the --output-graph option
to fissile.  Nodes that only appear in one file gets a red border, whereas nodes
that appear in multiple files get a green border.
=head2
Usage: $0 before.dot after.dot > combined.dot

=cut

use Data::Dumper;
$Data::Dumper::Indent = 1;
$Data::Dumper::Sortkeys = 1;

my %nodes = {};
print "strict digraph {\n";
while ($ARGV = shift) {
    open(INPUT, $ARGV);
    undef *nodes_in_this_graph;
    my %nodes_in_this_graph = {};
    while ($line = <INPUT>) {
        next if ($line =~ /^strict digraph/);
        next if ($line =~ /^}/);
        print $line;
        if ($line =~ /^"([^"]+)" \[/) {
            if (not exists($nodes_in_this_graph{$1})) {
                $nodes_in_this_graph{$1} = $1;
                $nodes{$1} ++;
            }
        }
    }
}

while (my ($node, $count) = each %nodes) {
    if ($count < 2) {
        print "\"$node\" [color=\"red\"]\n";
    } else {
        print "\"$node\" [color=\"green\"]\n";
    }
}

print "}\n";
